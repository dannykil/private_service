pipeline {
    agent any // Jenkinsfile이 실행될 Jenkins 워커 (Docker가 설치된 워커 권장)

    environment {
        // 배포될 Open WebUI 서비스의 포트 (원하는 포트로 변경)
        // docker-compose.yaml 파일의 포트 설정과 일치해야 합니다.
        // OPEN_WEBUI_PORT = '3000'
        OPEN_WEBUI_PORT = '8010'
        
        // Docker 이미지 이름 (원하는 이름으로 변경)
        DOCKER_IMAGE_NAME = "open-webui"
        // Docker 이미지 태그 (Jenkins 빌드 번호 사용)
        DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
        // 최종 이미지 이름
        FULL_DOCKER_IMAGE = "${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
    }

    stages {
        // 2025-09-23 jmkil
        // stage('Clean Workspace') {
        //     steps {
        //         cleanWs()
        //     }
        // }
        stage('Checkout Source') {
            steps {
                script {
                    // Git 저장소에서 소스 코드 가져오기
                    // 'your_git_repo_url'을 실제 Git 저장소 URL로 변경하세요.
                    // 'credentialsId'는 Jenkins에 설정된 Git 인증 정보 ID입니다.
                    // SSH 키를 사용한다면 'jenkins-ssh-credential' 등으로 설정
                    // 만약 공개 저장소라면 credentialsId는 필요 없습니다.
                    // checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/open-webui/open-webui.git', credentialsId: 'YOUR_GIT_CREDENTIAL_ID']]])
                    checkout([$class: 'GitSCM', branches: [[name: '*/master']], userRemoteConfigs: [[url: 'https://bitbucket.hist.co.kr/scm/hx-us/open-webui-0.6.5.git', credentialsId: '20ddd2c2-15e0-4a77-a9b7-ddf2e408b3f8']]])
                    // 또는 public repo인 경우
                    // checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/open-webui/open-webui.git']]])
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Dockerfile이 소스코드 루트 디렉토리에 있다고 가정
                    // Open WebUI 소스코드에 따라 Dockerfile 경로가 다를 수 있습니다.
                    // 예: frontend/Dockerfile, backend/Dockerfile 등
                    // 정확한 Dockerfile 위치를 확인하여 -f 옵션으로 지정해야 할 수 있습니다.
                    // Open WebUI 0.6.5 기준으로, 보통 루트에 docker-compose.yaml이 있고
                    // 그 안에 빌드 관련 정보가 있습니다.
                    
                    // docker-compose build 명령어를 사용하여 서비스 빌드
                    // -f 옵션으로 docker-compose.yaml 파일 경로 지정 (기본적으로는 생략 가능)
                    // --no-cache: 캐시를 사용하지 않고 새로 빌드
                    // docker-compose.yaml 파일에 지정된 서비스 이름(들)을 빌드
                    // Open WebUI는 보통 'ollama-webui' 또는 'webui'와 같은 서비스 이름을 사용합니다.
                    // docker-compose.yaml 파일을 확인하여 서비스 이름을 정확히 명시하세요.
                    // 예시: docker-compose build webui
                    
                    echo "Building Docker images using docker-compose..."
                    // Open WebUI 0.6.5 릴리스 기준으로, 보통 docker-compose.yaml 파일이 루트에 있으며
                    // 'webui' 서비스가 정의되어 있습니다.
                    // sh "docker-compose build --no-cache webui"
                    sh "docker-compose up -d"
                    
                    // 빌드된 이미지에 BUILD_NUMBER 태그 추가 (선택 사항, docker-compose build가 이미 태그를 생성할 수 있음)
                    // docker-compose.yaml이 이미 내부적으로 적절한 태그를 부여하므로 이 부분은 생략 가능하거나
                    // docker-compose.yaml 내용을 Jenkinsfile에 맞게 수정해야 할 수 있습니다.
                    // 만약 docker-compose.yaml이 특정 이미지 이름을 사용한다면, Jenkinsfile에서 그것을 따르거나
                    // docker-compose.yaml 파일을 수정하여 동적인 태그를 사용하도록 만들 수 있습니다.
                    // 현재 Open WebUI는 빌드 시 태그를 자동으로 생성하므로 이 단계는 생략합니다.
                }
            }
        }

        stage('Deploy with Docker Compose') {
            steps {
                script {
                    echo "Stopping existing Open WebUI containers..."
                    // 기존 Open WebUI 서비스 컨테이너 중지 및 삭제
                    // docker-compose.yaml 파일의 프로젝트 이름과 서비스 이름에 따라 명령어가 달라질 수 있습니다.
                    // -f 옵션으로 docker-compose.yaml 파일 경로 지정 (기본적으로는 생략 가능)
                    sh "docker-compose down"
                    
                    echo "Starting new Open WebUI containers..."
                    // 새 이미지로 Open WebUI 서비스 실행
                    // -d: detached mode (백그라운드 실행)
                    sh "docker-compose up -d"
                    
                    echo "Deployment complete! Open WebUI should be accessible on port ${OPEN_WEBUI_PORT}"
                }
            }
        }

        stage('Health Check (Optional)') {
            steps {
                script {
                    echo "Running a basic health check..."
                    // Open WebUI가 완전히 시작될 때까지 잠시 대기
                    sleep 30 // 서비스 시작에 필요한 시간 (환경에 따라 조절)
                    
                    // curl 등을 사용하여 웹 UI가 응답하는지 확인
                    // 실제 Open WebUI의 헬스 체크 엔드포인트가 있다면 해당 URL로 변경
                    try {
                        sh "curl --fail --silent http://localhost:${OPEN_WEBUI_PORT} > /dev/null"
                        echo "Open WebUI is up and running!"
                    } catch (Exception e) {
                        echo "Health check failed! Open WebUI might not be fully started or accessible."
                        // error "Health check failed!" // 에러 발생 시 파이프라인 실패
                    }
                }
            }
        }
    }

    post {
        always {
            // 빌드 성공/실패 여부와 관계없이 항상 실행
            echo "Pipeline finished."
        }
        success {
            echo "Open WebUI deployment successful!"
            // 성공 알림 (예: Slack, Email 등)
        }
        failure {
            echo "Open WebUI deployment failed!"
            // 실패 알림
        }
    }
}